<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Project Yasiki: Decompilation of Luigi's Mansion.">
    <link rel="stylesheet" href="https://moddi.dev/Yasiki/assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Reggae+One&disp=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito&disp=swap" rel="stylesheet">
    <link rel="icon" href="https://moddi.dev/Yasiki/assets/favicon.ico" type="image/x-icon">
    <title>File OSTime.c - Project Yasiki</title>
  </head>
  <body>
    <div class="container">
      <nav>
        <ul>
        </ul>
      </nav>

      <!--Upper bar-->
      <div id="bar">

          <!--Project text / logo-->
          <a id="barTitle" href="https://moddi.dev/Yasiki/"><b>Project Yasiki</b></a>
          <div style="display: flex; flex-direction: column; align-items: start;">
            
            <!--Both progress badges-->
            <a href="https://github.com/Moddimation/Yasiki">
              <img style="padding-top:10px; width: 90px;" src="https://decomp.dev/Moddimation/Yasiki.svg?mode=shield&measure=code&label=Code" alt="Go to github repo">
            </a>
            <a href="https://decomp.dev/Moddimation/Yasiki">
              <img style="padding-bottom:0px; width: 123px;" src="https://decomp.dev/Moddimation/Yasiki.svg?mode=shield&measure=functions&label=Progress" alt="Go to progress page">
            </a>
          </div>
          
          <p> </p>
          
          <!--Add each nav head here-->
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/files/'">Files</button>
            </li>
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/classes/'">Classes</button>
            </li>
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/wiki/'">Full Wiki</button>
            </li>
      </div>
      
      <h1 id="file-ostimec">File OSTime.c</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_0c56b33aa00ddb0e63af648508d6e3f4/"><strong>decomp</strong></a> <strong>&gt;</strong> <a href="../dir_7403dcf2df2f5392613493bf2b736904/"><strong>DolphinSDK</strong></a> <strong>&gt;</strong> <a href="../dir_84dd7f8d193350365bcacfbd02904e42/"><strong>src</strong></a> <strong>&gt;</strong> <a href="../dir_099eac09ed7894d1733885fc00e718ed/"><strong>dolphin</strong></a> <strong>&gt;</strong> <a href="../dir_c85f9e83f0f4b4374578811cecebda65/"><strong>os</strong></a> <strong>&gt;</strong> <a href="../_o_s_time_8c/"><strong>OSTime.c</strong></a></p>
<p><a href="../_o_s_time_8c/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">#include &lt;dolphin/exi.h&gt;
#include &lt;dolphin/os.h&gt;

#include &quot;OSPrivate.h&quot;

// End of each month in standard year
static int YearDays[MONTH_MAX]     = { 0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334 };
// End of each month in leap year
static int LeapYearDays[MONTH_MAX] = { 0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335 };

asm s64
OSGetTime (void)
{
#ifdef __MWERKS__
    nofralloc;

    mftbu r3;
    mftb  r4;

    // Check for possible carry from TBL to TBU
    mftbu r5;
    cmpw  r3, r5;
    bne   OSGetTime;

    blr;
#else
    return 0;
#endif
}

asm u32
OSGetTick (void)
{
#ifdef __MWERKS__
    nofralloc;

    mftb r3;
    blr;
#else
    return 0;
#endif
}

asm static void
__SetTime (s64 time)
{
#pragma unused(time)

#ifdef __MWERKS__
    nofralloc;
    li    r5, 0;
    mttbl r5;
    mttbu r3;
    mttbl r4;
    blr;
#endif
}

void
__OSSetTime (s64 time)
{
    int  enabled;
    s64* timeAdjustAddr;

    timeAdjustAddr   = (s64*)0x800030D8;
    enabled          = OSDisableInterrupts();

    *timeAdjustAddr += OSGetTime() - time;
    __SetTime (time);
    EXIProbeReset();
    OSRestoreInterrupts (enabled);
}

s64
__OSGetSystemTime ()
{
    int  enabled;
    s64* timeAdjustAddr;
    s64  result;

    timeAdjustAddr = (s64*)0x800030D8;
    enabled        = OSDisableInterrupts();

    result         = OSGetTime() + *timeAdjustAddr;
    OSRestoreInterrupts (enabled);
    return result;
}

asm void
__OSSetTick (register u32 newTicks)
{
#ifdef __MWERKS__
    nofralloc;
    mttbl newTicks;
    blr;
#endif
}

static int
IsLeapYear (int year)
{
    return (year % 4 == 0 &amp;&amp; year % 100 != 0) || (year % 400 == 0);
}

static int
GetYearDays (int year, int mon)
{
    int* md = (IsLeapYear (year)) ? LeapYearDays : YearDays;

    return md[mon];
}

static int
GetLeapDays (int year)
{
    ASSERTLINE (260, 0 &lt;= year);

    if (year &lt; 1)
    {
        return 0;
    }
    return (year + 3) / 4 - (year - 1) / 100 + (year - 1) / 400;
}

static void
GetDates (int days, OSCalendarTime* td)
{
    int  year;
    int  n;
    int  month;
    int* md;

    ASSERTLINE (285, 0 &lt;= days);

    td-&gt;wday = (days + 6) % WEEK_DAY_MAX;

    for (year = days / YEAR_DAY_MAX; days &lt; (n = year * YEAR_DAY_MAX + GetLeapDays (year));
         year--)
    {
        ;
    }

    days     -= n;
    td-&gt;year  = year;
    td-&gt;yday  = days;

    md        = IsLeapYear (year) ? LeapYearDays : YearDays;
    for (month = MONTH_MAX; days &lt; md[--month];) { ; }
    td-&gt;mon  = month;
    td-&gt;mday = days - md[month] + 1;
}

void
OSTicksToCalendarTime (s64 ticks, OSCalendarTime* td)
{
    int days;
    int secs;
    s64 d;

    d = ticks % OS_SEC_TO_TICKS (1);
    if (d &lt; 0)
    {
        d += OS_SEC_TO_TICKS (1);
        ASSERTLINE (330, 0 &lt;= d);
    }

    td-&gt;usec = (int)(OS_TICKS_TO_USEC (d) % USEC_MAX);
    td-&gt;msec = (int)(OS_TICKS_TO_MSEC (d) % MSEC_MAX);

    ASSERTLINE (334, 0 &lt;= td-&gt;usec);
    ASSERTLINE (335, 0 &lt;= td-&gt;msec);

    ticks -= d;

    ASSERTLINE (338, ticks % OSSecondsToTicks (1) == 0);
    ASSERTLINE (342,
                0 &lt;= OSTicksToSeconds (ticks) / 86400 + BIAS &amp;&amp;
                    OSTicksToSeconds (ticks) / 86400 + BIAS &lt;= INT_MAX);

    days = (int)((OS_TICKS_TO_SEC (ticks) / SECS_IN_DAY) + BIAS);
    secs = (int)(OS_TICKS_TO_SEC (ticks) % SECS_IN_DAY);
    if (secs &lt; 0)
    {
        days -= 1;
        secs += SECS_IN_DAY;
        ASSERTLINE (349, 0 &lt;= secs);
    }

    GetDates (days, td);
    td-&gt;hour = secs / 60 / 60;
    td-&gt;min  = secs / 60 % 60;
    td-&gt;sec  = secs % 60;
}

OSTime
OSCalendarTimeToTicks (OSCalendarTime* td)
{
    s64 secs;
    int ov_mon;
    int mon;
    int year;

    ov_mon = td-&gt;mon / MONTH_MAX;
    mon    = td-&gt;mon - (ov_mon * MONTH_MAX);

    if (mon &lt; 0)
    {
        mon += MONTH_MAX;
        ov_mon--;
    }

    ASSERTLINE (0x182,
                (ov_mon &lt;= 0 &amp;&amp; 0 &lt;= td-&gt;year + ov_mon) ||
                    (0 &lt; ov_mon &amp;&amp; td-&gt;year &lt;= INT_MAX - ov_mon));

    year = td-&gt;year + ov_mon;

    secs = (s64)SECS_IN_YEAR * year +
           (s64)SECS_IN_DAY * (GetLeapDays (year) + GetYearDays (year, mon) + td-&gt;mday - 1) +
           (s64)SECS_IN_HOUR * td-&gt;hour + (s64)SECS_IN_MIN * td-&gt;min + td-&gt;sec -
           (s64)0xEB1E1BF80ULL;

    return OS_SEC_TO_TICKS (secs) + OS_MSEC_TO_TICKS ((s64)td-&gt;msec) +
           OS_USEC_TO_TICKS ((s64)td-&gt;usec);
}
</code></pre>
        <script src="../../search/main.js"></script>
    </div>
  </body>
</html>