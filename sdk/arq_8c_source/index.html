<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Project Yasiki: Decompilation of Luigi's Mansion.">
    <link rel="stylesheet" href="https://moddi.dev/Yasiki/assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Reggae+One&disp=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito&disp=swap" rel="stylesheet">
    <link rel="icon" href="https://moddi.dev/Yasiki/assets/favicon.ico" type="image/x-icon">
    <title>File arq.c - Project Yasiki</title>
  </head>
  <body>
    <div class="container">
      <nav>
        <ul>
        </ul>
      </nav>

      <!--Upper bar-->
      <div id="bar">

          <!--Project text / logo-->
          <a id="barTitle" href="https://moddi.dev/Yasiki/"><b>Project Yasiki</b></a>
          <div style="display: flex; flex-direction: column; align-items: start;">
            
            <!--Both progress badges-->
            <a href="https://github.com/Moddimation/Yasiki">
              <img style="padding-top:10px; width: 90px;" src="https://decomp.dev/Moddimation/Yasiki.svg?mode=shield&measure=code&label=Code" alt="Go to github repo">
            </a>
            <a href="https://decomp.dev/Moddimation/Yasiki">
              <img style="padding-bottom:0px; width: 123px;" src="https://decomp.dev/Moddimation/Yasiki.svg?mode=shield&measure=functions&label=Progress" alt="Go to progress page">
            </a>
          </div>
          
          <p> </p>
          
          <!--Add each nav head here-->
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/files/'">Files</button>
            </li>
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/classes/'">Classes</button>
            </li>
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/wiki/'">Full Wiki</button>
            </li>
      </div>
      
      <h1 id="file-arqc">File arq.c</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_1f6a6668d55aa42931fc4b14e0914ad0/"><strong>ar</strong></a> <strong>&gt;</strong> <a href="../arq_8c/"><strong>arq.c</strong></a></p>
<p><a href="../arq_8c/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">#include &lt;dolphin.h&gt;
#include &lt;dolphin/ar.h&gt;

#include &quot;ar_private.h&quot;

static ARQRequest* __ARQRequestQueueHi;
static ARQRequest* __ARQRequestTailHi;
static ARQRequest* __ARQRequestQueueLo;
static ARQRequest* __ARQRequestTailLo;
static ARQRequest* __ARQRequestQueueTemp;
static ARQRequest* __ARQRequestTailTemp;
static ARQRequest* __ARQRequestPendingHi;
static ARQRequest* __ARQRequestPendingLo;
static ARQCallback __ARQCallbackHi;
static ARQCallback __ARQCallbackLo;
static u32         __ARQChunkSize;
static int         __ARQ_init_flag;

void
__ARQPopTaskQueueHi (void)
{
    if (__ARQRequestQueueHi)
    {
        if (__ARQRequestQueueHi-&gt;type == 0)
        {
            ARStartDMA (__ARQRequestQueueHi-&gt;type,
                        __ARQRequestQueueHi-&gt;source,
                        __ARQRequestQueueHi-&gt;dest,
                        __ARQRequestQueueHi-&gt;length);
        }
        else
        {
            ARStartDMA (__ARQRequestQueueHi-&gt;type,
                        __ARQRequestQueueHi-&gt;dest,
                        __ARQRequestQueueHi-&gt;source,
                        __ARQRequestQueueHi-&gt;length);
        }
        __ARQCallbackHi       = __ARQRequestQueueHi-&gt;callback;
        __ARQRequestPendingHi = __ARQRequestQueueHi;
        __ARQRequestQueueHi   = __ARQRequestQueueHi-&gt;next;
    }
}

void
__ARQServiceQueueLo (void)
{
    if (__ARQRequestPendingLo == 0 &amp;&amp; __ARQRequestQueueLo)
    {
        __ARQRequestPendingLo = __ARQRequestQueueLo;
        __ARQRequestQueueLo   = __ARQRequestQueueLo-&gt;next;
    }
    if (__ARQRequestPendingLo)
    {
        if (__ARQRequestPendingLo-&gt;length &lt;= __ARQChunkSize)
        {
            if (__ARQRequestPendingLo-&gt;type == 0)
            {
                ARStartDMA (__ARQRequestPendingLo-&gt;type,
                            __ARQRequestPendingLo-&gt;source,
                            __ARQRequestPendingLo-&gt;dest,
                            __ARQRequestPendingLo-&gt;length);
            }
            else
            {
                ARStartDMA (__ARQRequestPendingLo-&gt;type,
                            __ARQRequestPendingLo-&gt;dest,
                            __ARQRequestPendingLo-&gt;source,
                            __ARQRequestPendingLo-&gt;length);
            }
            __ARQCallbackLo = __ARQRequestPendingLo-&gt;callback;
        }
        else if (__ARQRequestPendingLo-&gt;type == 0)
        {
            ARStartDMA (__ARQRequestPendingLo-&gt;type,
                        __ARQRequestPendingLo-&gt;source,
                        __ARQRequestPendingLo-&gt;dest,
                        __ARQChunkSize);
        }
        else
        {
            ARStartDMA (__ARQRequestPendingLo-&gt;type,
                        __ARQRequestPendingLo-&gt;dest,
                        __ARQRequestPendingLo-&gt;source,
                        __ARQChunkSize);
        }
        __ARQRequestPendingLo-&gt;length -= __ARQChunkSize;
        __ARQRequestPendingLo-&gt;source += __ARQChunkSize;
        __ARQRequestPendingLo-&gt;dest   += __ARQChunkSize;
    }
}

void
__ARQCallbackHack (u32 unused)
{
#pragma unused(unused)
}

void
__ARQInterruptServiceRoutine ()
{
    if (__ARQCallbackHi)
    {
        __ARQCallbackHi ((u32)__ARQRequestPendingHi);
        __ARQRequestPendingHi = NULL;
        __ARQCallbackHi       = NULL;
    }
    else if (__ARQCallbackLo)
    {
        __ARQCallbackLo ((u32)__ARQRequestPendingLo);
        __ARQRequestPendingLo = NULL;
        __ARQCallbackLo       = NULL;
    }
    __ARQPopTaskQueueHi();
    if (__ARQRequestPendingHi == 0)
    {
        __ARQServiceQueueLo();
    }
}

void
__ARQInitTempQueue (void)
{
    __ARQRequestQueueTemp = NULL;
    __ARQRequestTailTemp  = NULL;
}

void
__ARQPushTempQueue (ARQRequest* task)
{
    if (!__ARQRequestQueueTemp)
    {
        __ARQRequestQueueTemp = task;
        __ARQRequestTailTemp  = task;
        return;
    }
    __ARQRequestTailTemp-&gt;next = task;
    __ARQRequestTailTemp       = task;
}

void
ARQInit (void)
{
    if (__ARQ_init_flag != 1)
    {
        __ARQRequestQueueHi = __ARQRequestQueueLo = NULL;
        __ARQChunkSize                            = 0x1000;
        ARRegisterDMACallback (__ARQInterruptServiceRoutine);
        __ARQRequestPendingHi = NULL;
        __ARQRequestPendingLo = NULL;
        __ARQCallbackHi       = NULL;
        __ARQCallbackLo       = NULL;
        __ARQ_init_flag       = 1;
    }
}

void
ARQReset (void)
{
    __ARQ_init_flag = 0;
}

void
ARQPostRequest (ARQRequest* request,
                u32         owner,
                u32         type,
                u32         priority,
                u32         source,
                u32         dest,
                u32         length,
                ARQCallback callback)
{
    int level;

    ASSERTLINE (0x1A9, request);
    ASSERTLINE (0x1AA, (type == ARQ_TYPE_MRAM_TO_ARAM) || (type == ARQ_TYPE_ARAM_TO_MRAM));
    ASSERTLINE (0x1AB, (priority == ARQ_PRIORITY_LOW) || (priority == ARQ_PRIORITY_HIGH));
    ASSERTLINE (0x1AE, (length % ARQ_DMA_ALIGNMENT) == 0);
    request-&gt;next   = NULL;
    request-&gt;owner  = owner;
    request-&gt;type   = type;
    request-&gt;source = source;
    request-&gt;dest   = dest;
    request-&gt;length = length;
    if (callback)
    {
        request-&gt;callback = callback;
    }
    else
    {
        request-&gt;callback = __ARQCallbackHack;
    }
    level = OSDisableInterrupts();
    switch (priority)
    {
        case ARQ_PRIORITY_LOW:
            if (__ARQRequestQueueLo)
            {
                __ARQRequestTailLo-&gt;next = request;
            }
            else
            {
                __ARQRequestQueueLo = request;
            }
            __ARQRequestTailLo = request;
            break;
        case ARQ_PRIORITY_HIGH:
            if (__ARQRequestQueueHi)
            {
                __ARQRequestTailHi-&gt;next = request;
            }
            else
            {
                __ARQRequestQueueHi = request;
            }
            __ARQRequestTailHi = request;
            break;
    }
    if ((__ARQRequestPendingHi == 0) &amp;&amp; (__ARQRequestPendingLo == 0))
    {
        __ARQPopTaskQueueHi();
        if (__ARQRequestPendingHi == 0)
        {
            __ARQServiceQueueLo();
        }
    }

    OSRestoreInterrupts (level);
}

void
ARQRemoveRequest (ARQRequest* request)
{
    ARQRequest* thisRequest;
    int         level;

    level = OSDisableInterrupts();
    __ARQInitTempQueue();
    for (thisRequest = __ARQRequestQueueHi; thisRequest; thisRequest = thisRequest-&gt;next)
    {
        if (thisRequest != request)
        {
            __ARQPushTempQueue (thisRequest);
        }
    }
    __ARQRequestQueueHi = __ARQRequestQueueTemp;
    __ARQRequestTailHi  = __ARQRequestTailTemp;
    __ARQInitTempQueue();
    for (thisRequest = __ARQRequestQueueLo; thisRequest; thisRequest = thisRequest-&gt;next)
    {
        if (thisRequest != request)
        {
            __ARQPushTempQueue (thisRequest);
        }
    }
    __ARQRequestQueueLo = __ARQRequestQueueTemp;
    __ARQRequestTailLo  = __ARQRequestTailTemp;
    if ((__ARQRequestPendingLo) &amp;&amp; (__ARQRequestPendingLo == request) &amp;&amp; (__ARQCallbackLo == 0))
    {
        __ARQRequestPendingLo = NULL;
    }

    OSRestoreInterrupts (level);
}

void
ARQRemoveOwnerRequest (u32 owner)
{
    ARQRequest* thisRequest;
    int         level;

    level = OSDisableInterrupts();
    __ARQInitTempQueue();
    for (thisRequest = __ARQRequestQueueHi; thisRequest; thisRequest = thisRequest-&gt;next)
    {
        if (thisRequest-&gt;owner != owner)
        {
            __ARQPushTempQueue (thisRequest);
        }
    }
    __ARQRequestQueueHi = __ARQRequestQueueTemp;
    __ARQRequestTailHi  = __ARQRequestTailTemp;
    __ARQInitTempQueue();
    for (thisRequest = __ARQRequestQueueLo; thisRequest; thisRequest = thisRequest-&gt;next)
    {
        if (thisRequest-&gt;owner != owner)
        {
            __ARQPushTempQueue (thisRequest);
        }
    }
    __ARQRequestQueueLo = __ARQRequestQueueTemp;
    __ARQRequestTailLo  = __ARQRequestTailTemp;
    if ((__ARQRequestPendingLo) &amp;&amp; (__ARQRequestPendingLo-&gt;owner == owner) &amp;&amp;
        (__ARQCallbackLo == 0))
    {
        __ARQRequestPendingLo = NULL;
    }

    OSRestoreInterrupts (level);
}

void
ARQFlushQueue (void)
{
    int level;

    level               = OSDisableInterrupts();
    __ARQRequestQueueHi = NULL;
    __ARQRequestTailHi  = NULL;
    __ARQRequestQueueLo = NULL;
    __ARQRequestTailLo  = NULL;
    if (__ARQCallbackLo == 0)
    {
        __ARQRequestPendingLo = NULL;
    }

    OSRestoreInterrupts (level);
}

void
ARQSetChunkSize (u32 size)
{
    u32 i;

    i = size &amp; 0x1F;
    if (i)
    {
        __ARQChunkSize = size + (0x20 - i);
        return;
    }
    __ARQChunkSize = size;
}

u32
ARQGetChunkSize (void)
{
    return __ARQChunkSize;
}
</code></pre>
        <script src="../../search/main.js"></script>
    </div>
  </body>
</html>