<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Project Yasiki: Decompilation of Luigi's Mansion.">
    <link rel="stylesheet" href="https://moddi.dev/Yasiki/assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Reggae+One&disp=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito&disp=swap" rel="stylesheet">
    <link rel="icon" href="https://moddi.dev/Yasiki/assets/favicon.ico" type="image/x-icon">
    <title>File delay.c - Project Yasiki</title>
  </head>
  <body>
    <div class="container">
      <nav>
        <ul>
        </ul>
      </nav>

      <!--Upper bar-->
      <div id="bar">

          <!--Project text / logo-->
          <a id="barTitle" href="https://moddi.dev/Yasiki/"><b>Project Yasiki</b></a>
          <div style="display: flex; flex-direction: column; align-items: start;">
            
            <!--Both progress badges-->
            <a href="https://github.com/Moddimation/Yasiki">
              <img style="padding-top:10px; width: 90px;" src="https://decomp.dev/Moddimation/Yasiki.svg?mode=shield&measure=code&label=Code" alt="Go to github repo">
            </a>
            <a href="https://decomp.dev/Moddimation/Yasiki">
              <img style="padding-bottom:0px; width: 123px;" src="https://decomp.dev/Moddimation/Yasiki.svg?mode=shield&measure=functions&label=Progress" alt="Go to progress page">
            </a>
          </div>
          
          <p> </p>
          
          <!--Add each nav head here-->
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/files/'">Files</button>
            </li>
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/classes/'">Classes</button>
            </li>
            <li>
              <button onclick="window.location.href='https://moddi.dev/Yasiki/wiki/'">Full Wiki</button>
            </li>
      </div>
      
      <h1 id="file-delayc">File delay.c</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_2bd0f0afbf5da90c596578eb9887bbaf/"><strong>axfx</strong></a> <strong>&gt;</strong> <a href="../delay_8c/"><strong>delay.c</strong></a></p>
<p><a href="../delay_8c/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">#include &lt;dolphin/ax.h&gt;
#include &lt;dolphin/axfx.h&gt;

#include &lt;dolphin.h&gt;

void
AXFXDelayCallback (struct AXFX_BUFFERUPDATE* bufferUpdate, struct AXFX_DELAY* delay)
{
    s32  l;
    s32  r;
    s32  s;
    s32* lBuf;
    s32* rBuf;
    s32* sBuf;
    u32  i;
    s32* left;
    s32* right;
    s32* sur;

    left = bufferUpdate-&gt;left;
    right = bufferUpdate-&gt;right;
    sur = bufferUpdate-&gt;surround;
    lBuf = delay-&gt;left + (delay-&gt;currentPos[0] * 0xA0);
    rBuf = delay-&gt;right + (delay-&gt;currentPos[1] * 0xA0);
    sBuf = delay-&gt;sur + (delay-&gt;currentPos[2] * 0xA0);

    for (i = 0; i &lt; 160; i++)
    {
        l = *lBuf;
        r = *rBuf;
        s = *sBuf;
        *lBuf++ = *left + ((s32)(l * delay-&gt;currentFeedback[0]) &gt;&gt; 7);
        *rBuf++ = *right + ((s32)(r * delay-&gt;currentFeedback[1]) &gt;&gt; 7);
        *sBuf++ = *sur + ((s32)(s * delay-&gt;currentFeedback[2]) &gt;&gt; 7);
        *left++ = (s32)(l * delay-&gt;currentOutput[0]) &gt;&gt; 7;
        *right++ = (s32)(r * delay-&gt;currentOutput[1]) &gt;&gt; 7;
        *sur++ = (s32)(s * delay-&gt;currentOutput[2]) &gt;&gt; 7;
    }
    delay-&gt;currentPos[0] = (s32)((delay-&gt;currentPos[0] + 1) % delay-&gt;currentSize[0]);
    delay-&gt;currentPos[1] = (s32)((delay-&gt;currentPos[1] + 1) % delay-&gt;currentSize[1]);
    delay-&gt;currentPos[2] = (s32)((delay-&gt;currentPos[2] + 1) % delay-&gt;currentSize[2]);
}

int
AXFXDelaySettings (struct AXFX_DELAY* delay)
{
    u32  i;
    s32* l;
    s32* r;
    s32* s;
    int  old;

    AXFXDelayShutdown (delay);
    old = OSDisableInterrupts();

    for (i = 0; i &lt; 3; i++)
    {
        delay-&gt;currentSize[i] = (((delay-&gt;delay[i] - 5) &lt;&lt; 5) + 0x9F) / 160U;
        delay-&gt;currentPos[i] = 0;
        delay-&gt;currentFeedback[i] = (delay-&gt;feedback[i] &lt;&lt; 7) / 100U;
        delay-&gt;currentOutput[i] = (delay-&gt;output[i] &lt;&lt; 7) / 100U;
    }
    delay-&gt;left = OSAllocFromHeap (__OSCurrHeap, delay-&gt;currentSize[0] * 0xA0 * 4);
    delay-&gt;right = OSAllocFromHeap (__OSCurrHeap, delay-&gt;currentSize[1] * 0xA0 * 4);
    delay-&gt;sur = OSAllocFromHeap (__OSCurrHeap, delay-&gt;currentSize[2] * 0xA0 * 4);
    ASSERTLINE (0x47, delay-&gt;left != NULL);
    ASSERTLINE (0x48, delay-&gt;right != NULL);
    ASSERTLINE (0x49, delay-&gt;sur != NULL);
    l = delay-&gt;left;
    r = delay-&gt;right;
    s = delay-&gt;sur;
    for (i = 0; i &lt; delay-&gt;currentSize[0] * 0xA0; i++)
    {
        *l++ = 0;
    }
    for (i = 0; i &lt; delay-&gt;currentSize[1] * 0xA0; i++)
    {
        *r++ = 0;
    }
    for (i = 0; i &lt; delay-&gt;currentSize[2] * 0xA0; i++)
    {
        *s++ = 0;
    }
    OSRestoreInterrupts (old);
    return 1;
}

int
AXFXDelayInit (struct AXFX_DELAY* delay)
{
    int old;

    old = OSDisableInterrupts();
    delay-&gt;left = NULL;
    delay-&gt;right = NULL;
    delay-&gt;sur = NULL;
    OSRestoreInterrupts (old);
    AXFXDelaySettings (delay);
}

int
AXFXDelayShutdown (struct AXFX_DELAY* delay)
{
    int old;

    old = OSDisableInterrupts();
    if (delay-&gt;left)
    {
        OSFreeToHeap (__OSCurrHeap, delay-&gt;left);
    }
    if (delay-&gt;right)
    {
        OSFreeToHeap (__OSCurrHeap, delay-&gt;right);
    }
    if (delay-&gt;sur)
    {
        OSFreeToHeap (__OSCurrHeap, delay-&gt;sur);
    }
    OSRestoreInterrupts (old);
    return 1;
}
</code></pre>
        <script src="../../search/main.js"></script>
    </div>
  </body>
</html>